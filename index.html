<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Oakstone Capital • Smart Savings Snapshot</title>
  <meta name="color-scheme" content="dark light">
  <style>
    :root{
      --bg:#000000;
      --card:#121212;
      --muted:#7a7a7a;
      --text:#ffffff;
      --blue:#0d6efd;
      --green:#28a745;
      --danger:#ef4444;
      --border:#222222;
    }
    *{box-sizing:border-box}
    html,body{margin:0;padding:0;background:var(--bg);color:var(--text);font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif}
    .container{max-width:1080px;margin:0 auto;padding:24px}
    header{background:#0a0a0a;border-bottom:1px solid var(--border)}
    header .wrap{display:flex;align-items:center;gap:12px;max-width:1080px;margin:0 auto;padding:14px 24px}
    header img{height:36px;width:auto}
    header .brand{line-height:1}
    header .brand .title{font-weight:600}
    header .brand .sub{font-size:11px;letter-spacing:.3em;color:#bdbdbd}
    .pill{border-radius:999px;padding:6px 10px;display:inline-block;font-size:12px}
    .badge-ok{background:color-mix(in srgb, var(--green) 18%, transparent);color:var(--green)}
    .badge-warn{background:color-mix(in srgb, #f59e0b 18%, transparent);color:#f59e0b}
    .badge-rose{background:color-mix(in srgb, var(--danger) 18%, transparent);color:var(--danger)}
    .row{display:grid;gap:16px}
    @media(min-width:900px){.row.cols-3{grid-template-columns:repeat(3,1fr)}.row.cols-2{grid-template-columns:repeat(2,1fr)}}
    .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:18px}
    .muted{color:var(--muted);font-size:12px}
    .h1{font-size:22px;font-weight:600;margin:0}
    .h2{font-size:16px;font-weight:600;margin:0 0 8px 0}
    .value{font-size:24px;font-weight:700}
    .input{width:100%;background:#0b0b0b;border:1px solid var(--border);border-radius:10px;color:var(--text);padding:10px}
    .input:focus{outline:2px solid color-mix(in srgb, var(--blue) 40%, transparent)}
    label{font-size:13px;display:block}
    .btn{border:1px solid color-mix(in srgb, var(--blue) 60%, var(--border));background:var(--blue);color:#fff;border-radius:999px;padding:10px 14px;font-weight:600;cursor:pointer}
    .btn.secondary{background:#0b0b0b;border-color:var(--border);color:#ddd}
    .btn.ghost{background:transparent;border-color:var(--border);color:#ddd}
    .btn:disabled{opacity:.6;cursor:not-allowed}
    .toggles{display:flex;gap:8px;align-items:center;flex-wrap:wrap}
    .grid-4{display:grid;gap:16px}@media(min-width:900px){.grid-4{grid-template-columns:repeat(4,1fr)}}
    .hide{display:none !important}
    .ok{color:var(--green)}
    .neg{color:#f59e0b}
    .hr{height:1px;background:var(--border);margin:16px 0}
    .foot{font-size:12px;color:#9b9b9b}
    .link{color:#8ab4ff;text-decoration:none}
    summary{cursor:pointer}
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <img id="logoImg" alt="Oakstone Capital" />
      <div class="brand">
        <div class="title">Oakstone Capital</div>
        <div class="sub">MORTGAGE • NMLS <span id="nmlsHdr">2585868</span></div>
      </div>
      <div style="margin-left:auto">
        <span id="modeBadge" class="pill badge-ok">Loan Officer Workspace</span>
      </div>
    </div>
  </header>

  <main class="container">
    <!-- LO WORKSPACE -->
    <section id="loPanel" class="card">
      <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
        <div class="h2" style="margin:0">Loan Officer Workspace</div>
        <span class="pill" style="background:#111;border:1px solid var(--border);color:#ccc">Private</span>
        <div class="toggles" style="margin-left:auto">
          <label><input type="checkbox" id="defaultSimple" checked> Default: Simple</label>
          <label><input type="checkbox" id="allowCosts"> Allow borrower cost details</label>
          <label><input type="checkbox" id="showChart"> Include “Why this works” chart</label>
          <label><input type="checkbox" id="emphasizeCredit"> Emphasize lender credit</label>
          <label><input type="checkbox" id="simpleCostsOnly" checked> Simple cost summary only</label>
        </div>
      </div>

      <div class="row cols-3">
        <div>
          <div class="h2">Borrower</div>
          <label>First name
            <input id="bFirst" class="input" placeholder="Alex">
          </label>
          <label style="margin-top:8px">Property address
            <input id="bAddr" class="input" placeholder="123 Oak Lane">
          </label>
          <label style="margin-top:8px">Email (for sharing)
            <input id="bEmail" class="input" placeholder="alex@email.com">
          </label>
        </div>

        <div>
          <div class="h2">Program</div>
          <label>Loan type
            <select id="loanType" class="input">
              <option>Conventional</option>
              <option>FHA</option>
              <option>FHA Cashout</option>
              <option>VA IRRRL</option>
              <option>VA Cashout</option>
            </select>
          </label>
          <label style="margin-top:8px">Purpose
            <select id="purpose" class="input">
              <option>Rate & Term</option>
              <option>Cashout</option>
              <option>IRRRL</option>
            </select>
          </label>
          <label style="margin-top:8px"><input id="vaSubseq" type="checkbox"> VA subsequent use</label>
          <label style="margin-top:8px"><input id="feeExempt" type="checkbox"> Funding fee exempt (VA)</label>
        </div>

        <div>
          <div class="h2">Branding</div>
          <label>Company NMLS
            <input id="nmls" class="input" value="2585868">
          </label>
          <label style="margin-top:8px">Logo URL (PNG/SVG)
            <input id="logoUrl" class="input" placeholder="https://.../logo.png">
          </label>
          <label style="margin-top:8px">LO name
            <input id="loName" class="input" placeholder="Steven">
          </label>
          <label style="margin-top:8px">LO phone
            <input id="loPhone" class="input" placeholder="(555) 555‑1234">
          </label>
          <label style="margin-top:8px">Reviews link (Google)
            <input id="reviews" class="input" placeholder="https://g.page/...">
          </label>
        </div>
      </div>

      <div class="hr"></div>

      <div class="row cols-2">
        <div>
          <div class="h2">Current Loan</div>
          <div class="row cols-2">
            <label>Balance
              <input id="curBal" class="input" type="number" placeholder="350000">
            </label>
            <label>Rate %
              <input id="curRate" class="input" type="number" step="0.001" placeholder="6.250">
            </label>
            <label>Years remaining
              <input id="curYears" class="input" type="number" placeholder="27">
            </label>
            <label>PMI / mo
              <input id="curPMI" class="input" type="number" placeholder="0">
            </label>
            <label>Taxes / mo
              <input id="tax" class="input" type="number" placeholder="450">
            </label>
            <label>Insurance / mo
              <input id="ins" class="input" type="number" placeholder="125">
            </label>
          </div>
        </div>

        <div>
          <div class="h2">Proposed Loan</div>
          <div class="row cols-2">
            <label>New loan amount
              <input id="newAmt" class="input" type="number" placeholder="375000">
            </label>
            <label>New rate %
              <input id="newRate" class="input" type="number" step="0.001" placeholder="5.990">
            </label>
            <label>Term (years)
              <input id="newYears" class="input" type="number" value="30">
            </label>
            <label>Funding/UFMIP %
              <input id="feePct" class="input" type="number" step="0.001" placeholder="Auto">
            </label>
            <label>New MI / MIP per mo
              <input id="newPMI" class="input" type="number" placeholder="0">
            </label>
            <label>Closing costs
              <input id="cc" class="input" type="number" placeholder="5500">
            </label>
            <label>Lender credits
              <input id="credit" class="input" type="number" placeholder="0">
            </label>
          </div>
          <label style="margin-top:8px">Cash‑out to borrower (enter 0 if none)
            <input id="cashout" class="input" type="number" value="0">
          </label>
        </div>
      </div>

      <details style="margin-top:12px">
        <summary>Optional: debt consolidation totals</summary>
        <div class="row cols-3" style="margin-top:8px">
          <label>Total balances to pay off
            <input id="debtBal" class="input" type="number" placeholder="28000">
          </label>
          <label>Total monthly payments (being eliminated)
            <input id="debtMo" class="input" type="number" placeholder="820">
          </label>
          <label>Avg interest % (optional)
            <input id="debtAvg" class="input" type="number" step="0.1" placeholder="19.9">
          </label>
        </div>
      </details>

      <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap" id="actions">
        <button id="previewBtn" class="btn">Preview borrower view</button>
        <button id="shareBtn" class="btn">Create share link</button>
        <span id="shareOut" class="muted"></span>
      </div>
    </section>

    <!-- BORROWER VIEW -->
    <section id="borrowerView" class="hide">
      <!-- High-rate alert -->
      <div id="rateAlert" class="pill badge-rose hide">You’re overpaying about <span id="overpayMo">$—</span>/mo at your current rate.</div>

      <div class="card" style="margin-top:12px">
        <div style="display:flex;gap:16px;align-items:flex-end;flex-wrap:wrap">
          <div style="flex:1">
            <div class="h1" id="heroTitle">Your Oakstone Smart Savings Snapshot</div>
            <div class="muted">Prepared by Oakstone Capital • NMLS <span id="nmlsOut">2585868</span></div>
          </div>
          <div class="toggles" id="viewToggles">
            <span class="muted">View:</span>
            <button id="btnSimple" class="btn secondary">Simple</button>
            <button id="btnDetail" class="btn ghost">Details</button>
          </div>
          <div style="text-align:right">
            <div class="muted">Property</div>
            <div id="addrOut" style="font-weight:600">—</div>
          </div>
        </div>
      </div>

      <!-- Highlight Cards -->
      <div class="grid-4" style="margin-top:12px">
        <div class="card">
          <div class="muted">Rate (Current → New)</div>
          <div class="value" id="rateCompare">—</div>
          <div class="muted">Fixed • <span id="termOut">30</span> yrs</div>
        </div>
        <div class="card">
          <div class="muted">New monthly (with taxes & insurance)</div>
          <div class="value" id="payOut">—</div>
          <div class="muted">Includes P&I, taxes, insurance, MI</div>
        </div>
        <div class="card">
          <div class="muted">Today vs New</div>
          <div class="value" id="todayVsNew">—</div>
          <div class="muted">Change in total monthly obligations</div>
        </div>
        <div class="card">
          <div class="muted">Impact</div>
          <div id="impactBadge" class="pill badge-ok">—</div>
          <div id="cashBadge" class="pill badge-warn hide">Cash out: —</div>
        </div>
      </div>

      <!-- Rate Breakdown (Details mode) -->
      <div id="rateBreakdown" class="card hide" style="margin-top:12px">
        <div class="muted" style="margin-bottom:8px">Rate Breakdown</div>
        <div class="row cols-2">
          <div>
            <div class="muted">Current Loan</div>
            <div>Rate: <strong id="curRateOut">—</strong></div>
            <div>P&I: <strong id="curPIOut">—</strong></div>
            <div>Total: <strong id="curTotOut">—</strong></div>
          </div>
          <div>
            <div class="muted">New Plan</div>
            <div>Rate: <strong id="newRateOut">—</strong></div>
            <div>P&I: <strong id="newPIOut">—</strong></div>
            <div>Total: <strong id="newTotOut">—</strong></div>
          </div>
        </div>
      </div>

      <!-- Narrative Benefit Block -->
      <div class="card" style="margin-top:12px">
        <div id="benefitHeadline" class="h2">—</div>
        <ul id="benefitBullets" style="margin:8px 0 0 0; padding-left:16px"></ul>

        <div id="costsWrapper" class="hide" style="margin-top:12px">
          <details id="costsDetails">
            <summary>Cost breakdown (optional)</summary>
            <div id="costsArea" style="margin-top:6px">—</div>
          </details>
        </div>

        <div style="margin-top:14px;display:flex;gap:10px;flex-wrap:wrap">
          <a id="ctaCall" class="btn" href="#">Schedule a call</a>
          <a id="ctaApply" class="btn secondary" href="#">Start application</a>
          <a id="ctaReviews" class="btn ghost" target="_blank">Reviews</a>
        </div>

        <div class="foot" style="margin-top:10px">This is not a commitment to lend. Rates and terms subject to change. Oakstone Capital • NMLS <span id="nmlsOut2">2585868</span>.</div>
      </div>

      <!-- Optional Why This Works Chart -->
      <section id="whySection" class="card hide" style="margin-top:12px">
        <div class="h2">Why this works (quick view)</div>
        <div class="muted">Projected loan balance after <span id="whyMonths">36</span> months — today vs. new plan.</div>
        <div id="whyChart" style="margin-top:10px"></div>
        <div class="foot" style="margin-top:6px">Illustrative; not a commitment to lend.</div>
      </section>
    </section>
  </main>

  <script>
    // Helpers
    function pmt(rate, nper, pv){
      const r = rate/1200;
      return r===0 ? -(pv/nper) : -(pv * r * Math.pow(1+r, nper)) / (Math.pow(1+r, nper) - 1);
    }
    function fmt(n){
      return isNaN(n)? '—' : n.toLocaleString(undefined,{style:'currency',currency:'USD',maximumFractionDigits:0});
    }
    function num(id){
      const v = parseFloat(document.getElementById(id).value);
      return isNaN(v)?0:v;
    }
    function autoFeePercent(loanType, vaSubseq, feeExempt){
      if (feeExempt && (loanType==='VA IRRRL' || loanType==='VA Cashout')) return 0;
      if (loanType==='FHA' || loanType==='FHA Cashout') return 1.75;
      if (loanType==='VA IRRRL') return 0.5;
      if (loanType==='VA Cashout') return vaSubseq ? 3.3 : 2.15;
      return 0;
    }

    // Lightweight bar chart (SVG) for 36-month principal balance comparison
    function balanceAfter(rate, years, pv, payment, months){
      const r = rate/1200; const n = years*12; const m = Math.min(months,n);
      let bal = pv;
      for (let i=0;i<m;i++){ const interest = bal * r; const princ = payment - interest; bal -= princ; if (bal<=0) return 0; }
      return Math.max(0, bal);
    }
    function renderWhyChart(curBal, curRate, curYears, newAmt, newRate, newYears){
      const months = 36;
      const curPmt = -pmt(curRate, curYears*12, curBal);
      const newPmt = -pmt(newRate, newYears*12, newAmt);
      const curBal36 = balanceAfter(curRate, curYears, curBal, curPmt, months);
      const newBal36 = balanceAfter(newRate, newYears, newAmt, newPmt, months);
      const maxVal = Math.max(curBal, newAmt);
      const h=140, bar=120, curX=100, newX=260, y=20;
      const curH = h * (curBal36/maxVal);
      const newH = h * (newBal36/maxVal);
      const svg = `
        <svg width="100%" viewBox="0 0 520 ${h+80}">
          <defs>
            <linearGradient id="g1" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#111827"/><stop offset="100%" stop-color="#6b7280"/>
            </linearGradient>
            <linearGradient id="g2" x1="0" x2="0" y1="0" y2="1">
              <stop offset="0%" stop-color="#059669"/><stop offset="100%" stop-color="#86efac"/>
            </linearGradient>
          </defs>
          <text x="60" y="14" font-size="12" fill="#9b9b9b">Balance after 36 months</text>
          <rect x="${curX}" y="${y}" width="${bar}" height="${curH}" fill="url(#g1)" rx="8"/>
          <rect x="${newX}" y="${y}" width="${bar}" height="${newH}" fill="url(#g2)" rx="8"/>
          <text x="${curX+bar/2}" y="${y+curH+16}" text-anchor="middle" font-size="12" fill="#9b9b9b">Today</text>
          <text x="${newX+bar/2}" y="${y+newH+16}" text-anchor="middle" font-size="12" fill="#9b9b9b">New plan</text>
          <text x="${curX+bar/2}" y="${y+curH-8}" text-anchor="middle" font-size="12" fill="#e5e7eb">${fmt(curBal36)}</text>
          <text x="${newX+bar/2}" y="${y+newH-8}" text-anchor="middle" font-size="12" fill="#86efac">${fmt(newBal36)}</text>
          <text x="260" y="${h+60}" text-anchor="middle" font-size="12" fill="#9b9b9b">Lower balance sooner → faster path to equity</text>
        </svg>`;
      document.getElementById('whyChart').innerHTML = svg;
    }

    // Main recalc + render
    function recalc(){
      const loanType = document.getElementById('loanType').value;
      const vaSubseq = document.getElementById('vaSubseq').checked;
      const feeExempt = document.getElementById('feeExempt').checked;
      const feePctInput = parseFloat(document.getElementById('feePct').value);
      const feePct = isNaN(feePctInput) ? autoFeePercent(loanType, vaSubseq, feeExempt) : feePctInput;

      const curBal=num('curBal');
      const curRate=num('curRate');
      const curYears=num('curYears');
      const curPMI=num('curPMI');
      const tax=num('tax');
      const ins=num('ins');

      const newAmt=num('newAmt');
      const newRate=num('newRate');
      const newYears=num('newYears')||30;
      const cc=num('cc');
      const credit=num('credit');
      const cashout=num('cashout');
      const debtMo=num('debtMo');
      const debtBal=num('debtBal');
      const newPMI=num('newPMI');

      const addFee = newAmt * (feePct/100);

      const curPI = -pmt(curRate, curYears*12, curBal);
      const curTotal = curPI + curPMI + tax + ins;

      const newPI = -pmt(newRate, newYears*12, newAmt);
      const newTotal = newPI + newPMI + tax + ins;

      const currentObligations = curTotal + debtMo;
      const newObligations = newTotal;
      const moDelta = currentObligations - newObligations;

      // Header + hero
      const first = document.getElementById('bFirst').value || 'You';
      document.getElementById('heroTitle').textContent = `${first}, your Smart Swap plan`;
      document.getElementById('addrOut').textContent = document.getElementById('bAddr').value || '—';
      document.getElementById('nmlsOut').textContent = document.getElementById('nmls').value || '2585868';
      document.getElementById('nmlsOut2').textContent = document.getElementById('nmls').value || '2585868';
      document.getElementById('nmlsHdr').textContent = document.getElementById('nmls').value || '2585868';

      // Rate Compare
      const rateCompareEl = document.getElementById('rateCompare');
      const curRateTxt = isNaN(curRate) ? '—' : (curRate.toFixed(3) + '%');
      const newRateTxt = isNaN(newRate) ? '—' : (newRate.toFixed(3) + '%');
      rateCompareEl.textContent = `${curRateTxt} → ${newRateTxt}`;
      document.getElementById('termOut').textContent = newYears || 30;

      // Main cards
      document.getElementById('payOut').textContent = fmt(newTotal);
      document.getElementById('todayVsNew').textContent = (moDelta>=0? '-' : '+') + fmt(Math.abs(moDelta)) + '/mo';
      const impact = moDelta >= 0 ? `Saves ${fmt(moDelta)}/mo` : `Costs ${fmt(Math.abs(moDelta))}/mo more`;
      const badge = document.getElementById('impactBadge');
      badge.textContent = impact;
      badge.className = 'pill ' + (moDelta>=0 ? 'badge-ok' : 'badge-warn');

      const cashBadge = document.getElementById('cashBadge');
      if (cashout>0){ cashBadge.textContent = `Cash out: ${fmt(cashout)}`; cashBadge.classList.remove('hide'); }
      else { cashBadge.classList.add('hide'); }

      // Bullets
      const bullets=[];
      if (moDelta>=0) bullets.push(`Lower total monthly outlay by <strong class="ok">${fmt(moDelta)}</strong>.`);
      if (cashout>0) bullets.push(`Receive <strong>${fmt(cashout)}</strong> cash at closing.`);
      if (debtBal>0 && debtMo>0) bullets.push(`Eliminate <strong>${fmt(debtBal)}</strong> of high‑interest balances and <strong>${fmt(debtMo)}</strong>/mo in payments.`);
      bullets.push(`Fixed rate of <strong>${newRateTxt}</strong> for <strong>${newYears}</strong> years.`);
      const feeLine = feePct>0 ? `${feePct.toFixed(3)}% program fee included.` : `No program funding fee.`;
      bullets.push(feeLine);
      document.getElementById('benefitHeadline').textContent = moDelta>=0 ? 'The Smart Swap: keep life simple, save monthly' : 'The Smart Swap: simplify bills and unlock cash';
      document.getElementById('benefitBullets').innerHTML = bullets.map(b=>`<li style="margin-left:0">${b}</li>`).join('');

      // High-rate alert (bad light but compliant)
      const rateAlert = document.getElementById('rateAlert');
      const overpayMoEl = document.getElementById('overpayMo');
      const curInterestMo = (curBal * (curRate/1200));
      const newInterestMo = (newAmt * (newRate/1200));
      const overpayMo = Math.max(0, currentObligations - newObligations);
      if (curRate > newRate && overpayMo > 0){
        rateAlert.classList.remove('hide');
        overpayMoEl.textContent = fmt(overpayMo);
      } else {
        rateAlert.classList.add('hide');
      }

      // Rate Breakdown (Details mode only)
      document.getElementById('curRateOut').textContent = curRateTxt;
      document.getElementById('newRateOut').textContent = newRateTxt;
      document.getElementById('curPIOut').textContent   = fmt(curPI);
      document.getElementById('newPIOut').textContent   = fmt(newPI);
      document.getElementById('curTotOut').textContent  = fmt(curTotal);
      document.getElementById('newTotOut').textContent  = fmt(newTotal);

      // Costs display
      const costsAllowed = (window.mode==='borrower' ? (qs.get('costs')==='1') : document.getElementById('allowCosts').checked);
      document.getElementById('costsWrapper').classList.toggle('hide', !costsAllowed);

      const emphasizeCredit = window.mode==='borrower' ? (qs.get('emphasizeCredit')==='1') : document.getElementById('emphasizeCredit').checked;
      const simpleCostsOnly = window.mode==='borrower' ? (qs.get('simpleCostsOnly')!=='0') : document.getElementById('simpleCostsOnly').checked;
      const netCosts = cc - credit + addFee;

      let lenderLine = '';
      if (credit > 0) lenderLine = emphasizeCredit ? ` Includes <span class="ok"><strong>${fmt(credit)}</strong> lender credit</span>.` : ` Includes lender credit of ${fmt(credit)}.`;

      let costHtml = '';
      if (simpleCostsOnly){
        costHtml = `Estimated total costs <strong>${fmt(cc)}</strong>.${lenderLine} Program fee ${fmt(addFee)} included. Net <strong>${fmt(netCosts)}</strong>.`;
      } else {
        costHtml = `
          <div>
            <div>Estimated total costs: <strong>${fmt(cc)}</strong></div>
            <div>Program fee: ${fmt(addFee)}</div>
            ${credit>0 ? `<div>Lender credit: <strong class="ok">${fmt(credit)}</strong></div>` : ``}
            <div class="muted" style="margin-top:6px">Regulated, itemized disclosures available on request.</div>
            <div style="margin-top:6px">Estimated net: <strong>${fmt(netCosts)}</strong></div>
          </div>`;
      }
      document.getElementById('costsArea').innerHTML = costHtml;

      // Chart
      const showChart = (window.mode==='borrower' ? (qs.get('chart')==='1') : document.getElementById('showChart').checked);
      const whySec = document.getElementById('whySection');
      if (showChart){ whySec.classList.remove('hide'); renderWhyChart(curBal, curRate, curYears, newAmt, newRate, newYears); }
      else { whySec.classList.add('hide'); }

      // Logo + CTAs
      const logo = document.getElementById('logoUrl').value || '';
      const img = document.getElementById('logoImg'); if (logo) img.src = logo;
      const phone = document.getElementById('loPhone').value || '';
      document.getElementById('ctaCall').href = phone ? `tel:${phone.replace(/[^0-9]/g,'')}` : '#';
      const reviews = document.getElementById('reviews').value || '#';
      const ctaReviews = document.getElementById('ctaReviews'); ctaReviews.href = reviews; ctaReviews.textContent = 'Reviews';
    }

    // Simple/Details mode
    let detailsMode = false;
    document.getElementById('btnSimple').addEventListener('click', ()=>{
      detailsMode = false;
      document.getElementById('btnSimple').className='btn secondary';
      document.getElementById('btnDetail').className='btn ghost';
      document.getElementById('rateBreakdown').classList.add('hide');
    });
    document.getElementById('btnDetail').addEventListener('click', ()=>{
      detailsMode = true;
      document.getElementById('btnDetail').className='btn secondary';
      document.getElementById('btnSimple').className='btn ghost';
      document.getElementById('rateBreakdown').classList.remove('hide');
    });

    // Share link builder & param reader
    function makeShareLink(){
      const f = ['bFirst','bAddr','loanType','purpose','vaSubseq','nmls','loName','loPhone','reviews','curBal','curRate','curYears','curPMI','tax','ins','newAmt','newRate','newYears','feePct','cc','credit','cashout','debtBal','debtMo','newPMI'];
      const p = new URLSearchParams();
      for (const id of f){
        const el = document.getElementById(id); if(!el) continue;
        const v = el.type==='checkbox' ? el.checked : el.value;
        if (v!=='' && v!==false) p.set(id, v);
      }
      p.set('view','borrower');
      if (document.getElementById('defaultSimple').checked) p.set('simple','1');
      if (document.getElementById('allowCosts').checked) p.set('costs','1');
      if (document.getElementById('showChart').checked) p.set('chart','1');
      if (document.getElementById('emphasizeCredit').checked) p.set('emphasizeCredit','1');
      if (!document.getElementById('simpleCostsOnly').checked) p.set('simpleCostsOnly','0');
      return location.origin + location.pathname + '?' + p.toString();
    }
    const qs = new URLSearchParams(location.search);

    // Wire inputs → recalc
    const watch = ['loanType','vaSubseq','feeExempt','feePct','curBal','curRate','curYears','curPMI','tax','ins','newAmt','newRate','newYears','cc','credit','cashout','debtMo','debtBal','bFirst','bAddr','nmls','loPhone','reviews','purpose','newPMI','logoUrl'];
    for (const id of watch){
      const el = document.getElementById(id); if (el) el.addEventListener('input', recalc);
    }

    // Buttons
    document.getElementById('previewBtn').addEventListener('click', ()=>{
      document.getElementById('loPanel').classList.add('hide');
      document.getElementById('borrowerView').classList.remove('hide');
      document.getElementById('modeBadge').textContent='Borrower View';
      recalc();
    });
    document.getElementById('shareBtn').addEventListener('click', ()=>{
      recalc();
      const url = makeShareLink();
      navigator.clipboard.writeText(url).catch(()=>{});
      document.getElementById('shareOut').textContent = 'Share link copied to clipboard';
    });

    // Borrower mode detection (via query string)
    if (qs.get('view')==='borrower'){
      document.getElementById('loPanel').classList.add('hide');
      document.getElementById('borrowerView').classList.remove('hide');
      document.getElementById('modeBadge').textContent='Borrower View';

      // Pre-fill from link
      const map = ['bFirst','bAddr','loanType','purpose','nmls','loName','loPhone','reviews','curBal','curRate','curYears','curPMI','tax','ins','newAmt','newRate','newYears','feePct','cc','credit','cashout','debtBal','debtMo','newPMI','logoUrl'];
      for (const k of map){ if (qs.get(k)!==null) document.getElementById(k).value = qs.get(k); }
      if (qs.get('vaSubseq')==='true') document.getElementById('vaSubseq').checked = true;
      if (qs.get('chart')==='1') document.getElementById('showChart').checked = true;

      // Default Simple vs Details
      if (qs.get('simple')==='1'){ detailsMode=false; document.getElementById('btnSimple').click(); }
      else { detailsMode=true; document.getElementById('btnDetail').click(); }
      recalc();
    } else {
      // Demo defaults for LO
      document.getElementById('bFirst').value='Alex';
      document.getElementById('bAddr').value='123 Oak Lane, Austin, TX';
      document.getElementById('loanType').value='FHA Cashout';
      document.getElementById('purpose').value='Cashout';
      document.getElementById('curBal').value=350000;
      document.getElementById('curRate').value=6.25;
      document.getElementById('curYears').value=27;
      document.getElementById('tax').value=450; document.getElementById('ins').value=125;
      document.getElementById('newAmt').value=385000; document.getElementById('newRate').value=5.99; document.getElementById('newYears').value=30;
      document.getElementById('cc').value=6200; document.getElementById('credit').value=0; document.getElementById('cashout').value=15000;
      document.getElementById('debtBal').value=28000; document.getElementById('debtMo').value=820;
      document.getElementById('newPMI').value=0;
      recalc();
    }
  </script>
</body>
</html>